{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Cadastro de Motorista</h4>
        </div>
        <div class="card-body">

            <style>
                .nav-tabs .nav-link {
                    font-weight: 500;
                    color: #000 !important;
                    border: none;
                    border-radius: 0;
                }

                .nav-tabs .nav-link.active {
                    font-weight: bold;
                    border-bottom: 4px solid #004085 !important;
                }

                .nav-link.tab-blue-1 { background-color: #cce5ff; }
                .nav-link.tab-blue-2 { background-color: #b3d7ff; }
                .nav-link.tab-blue-3 { background-color: #99ccff; }
                .nav-link.tab-blue-4 { background-color: #80bfff; }
                .nav-link.tab-blue-5 { background-color: #66b2ff; }
            </style>

            <form method="post">
                {% csrf_token %}

                {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Erro ao salvar:</strong>
                        <ul>
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <ul class="nav nav-tabs mb-4" id="tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link tab-blue-1 active" id="pessoal-tab" data-toggle="tab" href="#pessoal" role="tab">üìÑ Dados Pessoais</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link tab-blue-2" id="contato-tab" data-toggle="tab" href="#contato" role="tab">üìû Contato</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link tab-blue-3" id="veiculo-tab" data-toggle="tab" href="#veiculo" role="tab">üöö Ve√≠culo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link tab-blue-4" id="financeiro-tab" data-toggle="tab" href="#financeiro" role="tab">üè¶ Financeiro</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link tab-blue-5" id="extra-tab" data-toggle="tab" href="#extra" role="tab">üìå Extras</a>
                    </li>
                </ul>

                <div class="tab-content" id="tabsContent">
                    <!-- Pessoais -->
                    <div class="tab-pane fade show active" id="pessoal" role="tabpanel">
                        <div class="row">
                            <div class="form-group col-md-6">{{ form.nome.label_tag }} {{ form.nome|add_class:"form-control" }}</div>
                            <div class="form-group col-md-2">{{ form.tipo.label_tag }} {{ form.tipo|add_class:"form-control" }}</div>
                            <div class="form-group col-md-4">{{ form.cpf_cnpj.label_tag }} {{ form.cpf_cnpj|add_class:"form-control" }}</div>
                        </div>
                        <div class="row">
                            <div class="form-group col-md-3">{{ form.rg.label_tag }} {{ form.rg|add_class:"form-control" }}</div>
                            <div class="form-group col-md-3">{{ form.orgao_emissor.label_tag }} {{ form.orgao_emissor|add_class:"form-control" }}</div>
                            <div class="form-group col-md-3">{{ form.data_emissao_rg.label_tag }} {{ form.data_emissao_rg|add_class:"form-control"|attr:"type:date" }}</div>
                            <div class="form-group col-md-3">{{ form.data_nascimento.label_tag }} {{ form.data_nascimento|add_class:"form-control"|attr:"type:date" }}</div>
                        </div>
                        <div class="form-group">{{ form.cnh.label_tag }} {{ form.cnh|add_class:"form-control" }}</div>
                    </div>

                    <!-- Contato -->
                    <div class="tab-pane fade" id="contato" role="tabpanel">
                        <div class="row">
                            <div class="form-group col-md-4">{{ form.telefone.label_tag }} {{ form.telefone|add_class:"form-control" }}</div>
                            <div class="form-group col-md-4">{{ form.celular.label_tag }} {{ form.celular|add_class:"form-control" }}</div>
                            <div class="form-group col-md-4">{{ form.celular2.label_tag }} {{ form.celular2|add_class:"form-control" }}</div>
                        </div>
                        <div class="form-group">{{ form.email.label_tag }} {{ form.email|add_class:"form-control" }}</div>

                        <hr>

                        <div class="row">
                            <div class="form-group col-md-2">{{ form.cep.label_tag }} {{ form.cep|add_class:"form-control"|attr:"id:id_cep" }}</div>
                            <div class="form-group col-md-6">{{ form.rua.label_tag }} {{ form.rua|add_class:"form-control"|attr:"id:id_rua" }}</div>
                            <div class="form-group col-md-2">{{ form.numero.label_tag }} {{ form.numero|add_class:"form-control" }}</div>
                        </div>
                        <div class="row">
                            <div class="form-group col-md-5">{{ form.cidade.label_tag }} {{ form.cidade|add_class:"form-control" }}</div>
                            <div class="form-group col-md-3">{{ form.bairro.label_tag }} {{ form.bairro|add_class:"form-control" }}</div>
                            <div class="form-group col-md-3">{{ form.estado.label_tag }} {{ form.estado|add_class:"form-control"|attr:"id:id_estado" }}</div>
                        </div>
                    </div>

                    <!-- Ve√≠culo -->
                    <div class="tab-pane fade" id="veiculo" role="tabpanel">
                        <div class="row">
                            <div class="form-group col-md-4">{{ form.tipo_de_veiculo.label_tag }} {{ form.tipo_de_veiculo|add_class:"form-control" }}</div>
                            <div class="form-group col-md-4">{{ form.marca_modelo.label_tag }} {{ form.marca_modelo|add_class:"form-control" }}</div>
                            <div class="form-group col-md-2">{{ form.ano_fabricacao.label_tag }} {{ form.ano_fabricacao|add_class:"form-control"}}</div>
                        </div>
                        <div class="row">
                            <div class="form-group col-md-3">{{ form.placa.label_tag }} {{ form.placa|add_class:"form-control" }}</div>
                            <div class="form-group col-md-3">{{ form.cor.label_tag }} {{ form.cor|add_class:"form-control" }}</div>
                            <div class="form-group col-md-3">{{ form.capacidade_carga.label_tag }} {{ form.capacidade_carga|add_class:"form-control" }}</div>
                        </div>
                    </div>

                    <!-- Financeiro -->
                    <div class="tab-pane fade" id="financeiro" role="tabpanel">
                        <div id="mensagem_financeiro" class="alert alert-info text-center" style="display: none;">
                            Aba exclusiva para motoristas agregados. Clique em <strong>Pr√≥ximo</strong> para continuar.
                        </div>

                        <div id="campos_financeiro">
                            <div class="row">
                                <div class="form-group col-md-4">{{ form.banco.label_tag }} {{ form.banco|add_class:"form-control" }}</div>
                                <div class="form-group col-md-3">{{ form.agencia.label_tag }} {{ form.agencia|add_class:"form-control" }}</div>
                                <div class="form-group col-md-3">{{ form.conta.label_tag }} {{ form.conta|add_class:"form-control" }}</div>
                            </div>
                            <div class="row">
                                <div class="form-group col-md-2">{{ form.tipo_conta.label_tag }} {{ form.tipo_conta|add_class:"form-control" }}</div>
                                <div class="form-group col-md-6">{{ form.pix.label_tag }} {{ form.pix|add_class:"form-control" }}</div>
                            </div>
                        </div>
                    </div>


                    <!-- Extras -->
                    <div class="tab-pane fade" id="extra" role="tabpanel">
                        <div class="row">
                            <div class="form-group col-md-4">{{ form.cidade_base.label_tag }} {{ form.cidade_base|add_class:"form-control" }}</div>
                            <div class="form-group col-md-4">{{ form.disponibilidade.label_tag }} {{ form.disponibilidade|add_class:"form-control" }}</div>
                            <div class="form-group col-md-4">{{ form.ultima_roteirizacao.label_tag }} {{ form.ultima_roteirizacao|add_class:"form-control"|attr:"type:date" }}</div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="button" id="btnVoltar" class="btn btn-secondary px-4 mr-2">Voltar</button>
                    <button type="button" id="btnProximo" class="btn btn-primary px-4 mr-2">Pr√≥ximo</button>
                    <button type="submit" id="btnSalvar" class="btn btn-success px-5 d-none">Salvar</button>
                    <a href="{% url 'todosmotoristas_list' %}" class="btn btn-outline-secondary px-4 ml-2">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const tipoSelect = document.getElementById("id_tipo");
    const financeiroTabBtn = document.getElementById("financeiro-tab");
    const financeiroTabPane = document.getElementById("financeiro");
    const camposFinanceiro = document.getElementById("campos_financeiro");
    const mensagemFinanceiro = document.getElementById("mensagem_financeiro");

    function toggleFinanceiroTab() {
        const isAgregado = tipoSelect && tipoSelect.value === "AG";

        // Exibir/ocultar bot√£o da aba
        financeiroTabBtn.parentElement.style.display = "block";

        // Mostrar ou esconder campos com base no tipo
        if (isAgregado) {
            camposFinanceiro.style.display = "block";
            mensagemFinanceiro.style.display = "none";
        } else {
            camposFinanceiro.style.display = "none";
            mensagemFinanceiro.style.display = "block";
        }

        // Caso a aba financeira esteja ativa e for tipo PR, mostra mensagem
        if (!isAgregado && financeiroTabBtn.classList.contains("active")) {
            mensagemFinanceiro.style.display = "block";
        }
    }

    if (tipoSelect) {
        tipoSelect.addEventListener("change", toggleFinanceiroTab);
        toggleFinanceiroTab(); // Executa na carga da p√°gina
    }
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const abas = document.querySelectorAll("#tabs .nav-link");
    const conteudos = document.querySelectorAll("#tabsContent .tab-pane");
    const btnProximo = document.getElementById("btnProximo");
    const btnVoltar = document.getElementById("btnVoltar");
    const btnSalvar = document.getElementById("btnSalvar");

    let indiceAtual = 0;

    function mostrarAba(indice) {
        abas.forEach((aba, i) => {
            aba.classList.toggle("active", i === indice);
            if (i === indice) {
                aba.setAttribute("aria-selected", "true");
            } else {
                aba.setAttribute("aria-selected", "false");
            }
        });
        conteudos.forEach((conteudo, i) => {
            conteudo.classList.toggle("show", i === indice);
            conteudo.classList.toggle("active", i === indice);
        });

        btnVoltar.style.display = indice === 0 ? "none" : "inline-block";
        btnProximo.style.display = indice === abas.length - 1 ? "none" : "inline-block";
        btnSalvar.classList.toggle("d-none", indice !== abas.length - 1);
    }

    btnProximo.addEventListener("click", function () {
        if (indiceAtual < abas.length - 1) {
            indiceAtual++;
            mostrarAba(indiceAtual);
        }
    });

    btnVoltar.addEventListener("click", function () {
        if (indiceAtual > 0) {
            indiceAtual--;
            mostrarAba(indiceAtual);
        }
    });

    abas.forEach((aba, i) => {
        aba.addEventListener("click", function (e) {
            e.preventDefault();
            indiceAtual = i;
            mostrarAba(indiceAtual);
        });
    });

    mostrarAba(indiceAtual);  // inicializa na primeira aba
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const cep = document.getElementById("id_cep");
    const rua = document.getElementById("id_rua");
    const bairro = document.getElementById("id_bairro");
    const cidade = document.getElementById("id_cidade");
    const estado = document.getElementById("id_estado");

    const numero = document.getElementById("id_numero");

    cep.addEventListener("blur", function () {
        const cepVal = cep.value.replace(/\D/g, '');
        if (cepVal.length !== 8) {
            return;
        }

        fetch(`https://viacep.com.br/ws/${cepVal}/json/`)
            .then(response => response.json())
            .then(data => {
                if (!data.erro) {
                    rua.value = data.logradouro || '';
                    bairro.value = data.bairro || '';
                    cidade.value = data.localidade || '';
                    estado.value = data.uf || '';

                    // ‚úÖ Focar no campo n√∫mero ap√≥s preenchimento do CEP
                    setTimeout(() => {
                        numero.focus();
                    }, 100);
                }
            })
            .catch(error => {
                console.error("Erro ao buscar o CEP:", error);
            });
    });
});
</script>

{% endblock %}
